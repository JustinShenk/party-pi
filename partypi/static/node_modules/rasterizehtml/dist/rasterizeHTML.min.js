/*! rasterizeHTML.js - v1.3.0 - 2018-03-18
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2018 Christoph Burgmer; Licensed MIT */

!function(o,i){void 0===o&&void 0!==window&&(o=window),"function"==typeof define&&define.amd?define(["url","xmlserializer","sane-domparser-error","inlineresources"],function(e,t,n,r){return o.rasterizeHTML=i(e,t,n,r)}):"object"==typeof module&&module.exports?module.exports=i(require("url"),require("xmlserializer"),require("sane-domparser-error"),require("inlineresources")):o.rasterizeHTML=i(o.url,o.xmlserializer,o.sanedomparsererror,o.inlineresources)}(this,function(e,t,n,r){var o=function(n){"use strict";var o={},t=[];o.joinUrl=function(e,t){return e?n.resolve(e,t):t},o.getConstantUniqueIdFor=function(e){return t.indexOf(e)<0&&t.push(e),t.indexOf(e)},o.clone=function(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n};return o.parseOptionalParameters=function(e){var t,n,r={canvas:null,options:{}};return null==e[0]||(t=e[0],"object"==typeof(n=t)&&null!==n&&Object.prototype.toString.apply(t).match(/\[object (Canvas|HTMLCanvasElement)\]/i))?(r.canvas=e[0]||null,r.options=o.clone(e[1])):r.options=o.clone(e[0]),r},o}(e),i=function(c){"use strict";var e={},u=function(e,t,n){var r=e[t];return e[t]=function(){var e=Array.prototype.slice.call(arguments);return n.apply(this,[e,r])},r};return e.baseUrlRespectingXhr=function(t,i){return function(){var e=new t;return u(e,"open",function(e,t){var n=e.shift(),r=e.shift(),o=c.joinUrl(i,r);return t.apply(this,[n,o].concat(e))}),e}},e.finishNotifyingXhr=function(t){var n,r=0,o=0,i=!1,e=new Promise(function(e){n=function(){r-o<=0&&i&&e({totalCount:r})}}),c=function(){var e=new t;return u(e,"send",function(e,t){return r+=1,t.apply(this,arguments)}),e.addEventListener("load",function(){o+=1,n()}),e};return c.waitForRequestsToFinish=function(){return i=!0,n(),e},c},e}(o),c=function(c){"use strict";var e={},o=function(e){return Array.prototype.slice.call(e)},u={active:!0,hover:!0,focus:!1,target:!1};return e.fakeUserAction=function(e,t,n){var r=e.querySelector(t),o=":"+n,i="rasterizehtml"+n;r&&(u[n]?c.addClassNameRecursively(r,i):c.addClassName(r,i),c.rewriteCssSelectorWith(e,o,"."+i))},e.persistInputValues=function(e){var t=e.querySelectorAll("input"),n=e.querySelectorAll("textarea"),r=function(e){return"checkbox"===e.type||"radio"===e.type};o(t).filter(r).forEach(function(e){e.checked?e.setAttribute("checked",""):e.removeAttribute("checked")}),o(t).filter(function(e){return!r(e)}).forEach(function(e){e.setAttribute("value",e.value)}),o(n).forEach(function(e){e.textContent=e.value})},e.rewriteTagNameSelectorsToLowerCase=function(e){c.lowercaseCssTypeSelectors(e,c.findHtmlOnlyNodeNames(e))},e}(function(){"use strict";var n={},u=function(e){return Array.prototype.slice.call(e)};n.addClassName=function(e,t){e.className+=" "+t},n.addClassNameRecursively=function(e,t){n.addClassName(e,t),e.parentNode!==e.ownerDocument&&n.addClassNameRecursively(e.parentNode,t)};var a=function(e,t){var n,r,o,i,c=e.cssText.replace(/^[^\{]+/,"");r=t+" "+c,o=(n=e).parentStyleSheet,i=u(o.cssRules).indexOf(n),o.insertRule(r,i+1),o.deleteRule(i)},s=function(e){var t;e.textContent=(t=e.sheet.cssRules,u(t).reduce(function(e,t){return e+t.cssText},""))},r=function(e,t,i){var c="((?:^|[^.#:\\w])|(?=\\W))("+t.join("|")+")(?=\\W|$)";u(e.querySelectorAll("style")).forEach(function(e){var t,n,r;void 0===e.sheet&&(t=e,n=document.implementation.createHTMLDocument(""),(r=document.createElement("style")).textContent=t.textContent,n.body.appendChild(r),t.sheet=r.sheet);var o=u(e.sheet.cssRules).filter(function(e){return e.selectorText&&new RegExp(c,"i").test(e.selectorText)});o.length&&(o.forEach(function(e){var t=e.selectorText.replace(new RegExp(c,"gi"),function(e,t,n){return t+i(n)});t!==e.selectorText&&a(e,t)}),s(e))})};return n.rewriteCssSelectorWith=function(e,t,n){r(e,[t],function(){return n})},n.lowercaseCssTypeSelectors=function(e,t){r(e,t,function(e){return e.toLowerCase()})},n.findHtmlOnlyNodeNames=function(e){for(var t,n=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_ELEMENT),r={},o={};t=n.currentNode.tagName.toLowerCase(),"http://www.w3.org/1999/xhtml"===n.currentNode.namespaceURI?r[t]=!0:o[t]=!0,n.nextNode(););return Object.keys(r).filter(function(e){return!o[e]})},n}()),u=function(l,v,t,w){"use strict";var e={};e.executeJavascript=function(h,p){return new Promise(function(t){var e,n,r,o,i,c=(e=w.document,n="iframe",r=p.width,o=p.height,(i=e.createElement(n)).style.visibility="hidden",i.style.width=r+"px",i.style.height=o+"px",i.style.position="absolute",i.style.top=-1e4-o+"px",i.style.left=-1e4-r+"px",e.getElementsByTagName("body")[0].appendChild(i),i),u=h.outerHTML,a=[],s=p.executeJsTimeout||0,l=function(){var e=c.contentDocument;w.document.getElementsByTagName("body")[0].removeChild(c),t({document:e,errors:a})},f=c.contentWindow.XMLHttpRequest,m=v.finishNotifyingXhr(f),d=v.baseUrlRespectingXhr(m,p.baseUrl);c.onload=function(){var t;(t=s,0<t?new Promise(function(e){setTimeout(e,t)}):Promise.resolve()).then(m.waitForRequestsToFinish).then(l)},c.contentDocument.open(),c.contentWindow.XMLHttpRequest=d,c.contentWindow.onerror=function(e){a.push({resourceType:"scriptExecution",msg:e})},c.contentDocument.write("<!DOCTYPE html>"),c.contentDocument.write(u),c.contentDocument.close()})};var g=function(e,t,n,r,o){var i,c,u,a,s,l,f,m,d,h,p,v=Math.max(e.scrollWidth,e.clientWidth),g=Math.max(e.scrollHeight,e.clientHeight);return t?(i=(l=function(e,t){var n=e.querySelector(t);if(n)return n;if(e.ownerDocument.querySelector(t)===e)return e;throw{message:"Clipping selector not found"}}(e,t).getBoundingClientRect()).top,c=l.left,u=l.width,a=l.height):(c=i=0,u=v,a=g),m={width:u,height:a},d=n,h=r,p=o,f={width:Math.max(m.width*p,d),height:Math.max(m.height*p,h)},s=w.getComputedStyle(e.ownerDocument.documentElement).fontSize,{left:c,top:i,width:f.width,height:f.height,viewportWidth:v,viewportHeight:g,rootFontSize:s}};e.calculateDocumentContentSize=function(p,v){return new Promise(function(o,i){var c,e,t,n,r,u,a,s,l,f,m,d,h=v.zoom||1;e=v.width,t=v.height,n=h,l=Math.floor(e/n),f=Math.floor(t/n),r=w.document,u=l,a=f,(s=r.createElement("iframe")).style.width=u+"px",s.style.height=a+"px",s.style.visibility="hidden",s.style.position="absolute",s.style.top=-1e4-a+"px",s.style.left=-1e4-u+"px",s.style.borderWidth=0,s.sandbox="allow-same-origin",s.scrolling="no",c=s,w.document.getElementsByTagName("body")[0].appendChild(c),c.onload=function(){var e,t,n,r=c.contentDocument;try{e=g((t=r,n=p.tagName,t.querySelector(n)),v.clip,v.width,v.height,h),o(e)}catch(e){i(e)}finally{w.document.getElementsByTagName("body")[0].removeChild(c)}},c.contentDocument.open(),c.contentDocument.write("<!DOCTYPE html>"),c.contentDocument.write("html"===(d=(m=p).tagName.toLowerCase())||"body"===d?m.outerHTML:'<body style="margin: 0;">'+m.outerHTML+"</body>"),c.contentDocument.close()})},e.parseHtmlFragment=function(e){var t=w.document.implementation.createHTMLDocument("");t.documentElement.innerHTML=e;var n=t.querySelector("body").firstChild;if(!n)throw"Invalid source";return n};e.parseHTML=function(e){var t=w.document.implementation.createHTMLDocument("");return t.documentElement.innerHTML=e,function(e,t){var n,r,o,i,c=/<html((?:\s+[^>]*)?)>/im.exec(t),u=w.document.implementation.createHTMLDocument("");if(c)for(n="<div"+c[1]+"></div>",u.documentElement.innerHTML=n,o=u.querySelector("div"),r=0;r<o.attributes.length;r++)i=o.attributes[r],e.documentElement.setAttribute(i.name,i.value)}(t,e),t};var n=function(e){try{return t.failOnParseError(e)}catch(e){throw{message:"Invalid source",originalError:e}}};e.validateXHTML=function(e){var t=(new DOMParser).parseFromString(e,"application/xml");n(t)};var f=null,r=function(a,s){return new Promise(function(e,t){var n,r,o=new window.XMLHttpRequest,i=l.joinUrl(s.baseUrl,a),c=(n=i,"none"===(r=s.cache)||"repeated"===r?(null!==f&&"repeated"===r||(f=Date.now()),n+"?_="+f):n),u=function(e){t({message:"Unable to load page",originalError:e})};o.addEventListener("load",function(){200===o.status||0===o.status?e(o.responseXML):u(o.statusText)},!1),o.addEventListener("error",function(e){u(e)},!1);try{o.open("GET",c,!0),o.responseType="document",o.send(null)}catch(e){u(e)}})};return e.loadDocument=function(e,t){return r(e,t).then(function(e){return n(e)})},e}(o,i,n,window),a=function(r){"use strict";var e,t={},o=function(e,t){return t?URL.createObjectURL(new Blob([e],{type:"image/svg+xml"})):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)},c=function(e){e instanceof Blob&&URL.revokeObjectURL(e)},i='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><foreignObject></foreignObject></svg>',u=function(o){return new Promise(function(t,e){var n=document.createElement("canvas"),r=new Image;r.onload=function(){var e=n.getContext("2d");try{e.drawImage(r,0,0),n.toDataURL("image/png"),t(!0)}catch(e){t(!1)}},r.onerror=e,r.src=o})},n=function(){return new Promise(function(t,e){var n;(function(){if(r.Blob)try{return new Blob(["<b></b>"],{type:"text/xml"}),!0}catch(e){}return!1})()&&r.URL?(n=o(i,!0),u(n).then(function(e){return c(n),!e&&u(o(i,!1)).then(function(e){return e})},function(){return!1})).then(function(e){t(!e)},function(){e()}):t(!1)})},a=function(t){return(void 0===e&&(e=n()),e).then(function(e){return o(t,e)})};return t.renderSvg=function(i){return new Promise(function(e,t){var n,r,o=function(){n&&c(n)};(r=new Image).onload=function(){r.onload=null,r.onerror=null,o(),e(r)},r.onerror=function(){o(),t()},a(i).then(function(e){n=e,r.src=n},t)})},t}(window);return function(f,u,m){"use strict";var a={};a.drawDocument=function(){var e,t,n,r,o,i,c,u=arguments[0],a=Array.prototype.slice.call(arguments,1),s=f.parseOptionalParameters(a),l=u.documentElement?u.documentElement:u;return m.rasterize(l,s.canvas,(n=(e=s).canvas,r=e.options,o=n?n.width:300,i=n?n.height:200,c={width:void 0!==r.width?r.width:o,height:void 0!==r.height?r.height:i},(t=f.clone(e.options)).width=c.width,t.height=c.height,t))};a.drawHTML=function(){var e,t,n,r,o=arguments[0],i=Array.prototype.slice.call(arguments,1),c=f.parseOptionalParameters(i);return e=o,t=c.canvas,n=c.options,r=u.parseHTML(e),a.drawDocument(r,t,n)};var r=function(n,r,o){return u.loadDocument(n,o).then(function(e){var t=function(e,t,n){var r=document.implementation.createHTMLDocument("");r.replaceChild(e.documentElement,r.documentElement);var o=n?f.clone(n):{};return n.baseUrl||(o.baseUrl=t),{document:r,options:o}}(e,n,o);return a.drawDocument(t.document,r,t.options)})};return a.drawURL=function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1),n=f.parseOptionalParameters(t);return r(e,n.canvas,n.options)},a}(o,u,function(n,i,c,r,e,u){"use strict";var t={},o=function(e){return{message:"Error rendering page",originalError:e}},a=function(t){return e.renderSvg(t).then(function(e){return{image:e,svg:t}},function(e){throw o(e)})},s=function(e,t,n){return r.drawDocumentAsSvg(e,n).then(a).then(function(e){return t&&function(e,t){try{t.getContext("2d").drawImage(e,0,0)}catch(e){throw o(e)}}(e.image,t),e})};return t.rasterize=function(r,e,o){var t;return(t=n.clone(o)).inlineScripts=!0===o.executeJs,u.inlineReferences(r,t).then(function(t){return o.executeJs?(e=r,n=o,i.executeJavascript(e,n).then(function(e){var t=e.document;return c.persistInputValues(t),{document:t,errors:e.errors}})).then(function(e){return{element:e.document.documentElement,errors:t.concat(e.errors)}}):{element:r,errors:t};var e,n}).then(function(t){return s(t.element,e,o).then(function(e){return{image:e.image,svg:e.svg,errors:t.errors}})})},t}(o,u,c,function(e,d,r,h){"use strict";var o={},p=function(t){var e=Object.keys(t);return e.length?" "+e.map(function(e){return e+'="'+t[e]+'"'}).join(" "):""},i=function(e,t,n){var r=h.serializeToString(e);d.validateXHTML(r);var o,i,c,u,a,s,l,f,m=(o=t,i=Math.round(o.viewportWidth),c=Math.round(o.viewportHeight),{x:-o.left,y:-o.top,width:i,height:c});return a=(u=m).style||"",u.style=a+"float: left;",m.externalResourcesRequired=!0,'<svg xmlns="http://www.w3.org/2000/svg"'+p((l=n||1,f={width:(s=t).width,height:s.height,"font-size":s.rootFontSize},1!==l&&(f.style="transform:scale("+l+"); transform-origin: 0 0;"),f))+'><style scoped="">html::-webkit-scrollbar { display: none; }</style><foreignObject'+p(m)+">"+r+"</foreignObject></svg>"};return o.getSvgForDocument=function(e,t,n){return r.rewriteTagNameSelectorsToLowerCase(e),i(e,t,n)},o.drawDocumentAsSvg=function(t,n){return["hover","active","focus","target"].forEach(function(e){n[e]&&r.fakeUserAction(t,n[e],e)}),d.calculateDocumentContentSize(t,n).then(function(e){return o.getSvgForDocument(t,e,n.zoom)})},o}(0,u,c,t),a,r))});